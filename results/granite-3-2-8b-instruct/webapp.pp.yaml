- name: Ensure webapps directory exists
  file:
    path: /opt/webapps
    state: directory

- name: Ensure required packages are installed
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - rubygems
    - ruby-dev
    - libxml2-dev
    - libxslt-dev
    - libsqlite3-dev
    - libmysqlclient-dev

- name: Ensure bundler is installed
  gem:
    name: bundler
    state: present

- name: Ensure apache is installed
  apt:
    name: apache2
    state: present

- name: Ensure apache proxy_http module is enabled
  apache2_module:
    name: proxy_http
    state: present

- name: Ensure webapps directory exists
  file:
    path: /opt/webapps
    state: directory

- name: Ensure webapps repo is cloned
  git:
    repo: "{{ service_webapp_repo }}"
    dest: "{{ WEBAPP_PATH }}"
    version: "{{ service_webapp_tag }}"

- name: Ensure webapps tag is checked out
  command: git checkout {{ service_webapp_tag }}
  args:
    chdir: "{{ WEBAPP_PATH }}"

- name: Ensure Gemfile.local is created
  template:
    src: webapp/Gemfile.local.j2
    dest: "{{ WEBAPP_PATH }}/Gemfile.local"

- name: Ensure bundler is installed
  gem:
    name: bundler
    state: present

- name: Ensure required gems are installed
  command: bundle install --without development test rmagick postgresql
  args:
    chdir: "{{ WEBAPP_PATH }}"

- name: Ensure secret key is generated
  command: bundle exec rake generate_session_store
  args:
    chdir: "{{ WEBAPP_PATH }}"

- name: Ensure database.yml is configured
  template:
    src: webapp/database.yml.j2
    dest: "{{ WEBAPP_PATH }}/config/database.yml"

- name: Ensure database is migrated and default data is loaded
  command: bundle exec rake db:migrate RAILS_ENV=production && bundle exec rake redmine:load_default_data RAILS_ENV=production REDMINE_LANG=en
  args:
    chdir: "{{ WEBAPP_PATH }}"

- name: Ensure unicorn is installed
  gem:
    name: unicorn
    state: present

- name: Ensure unicorn service is configured
  template:
    src: webapp/unicorn.j2
    dest: /etc/init/unicorn.conf
  notify:
    - restart unicorn

- name: Ensure apache vhost is configured
  template:
    src: webapp/vhost.j2
    dest: /etc/apache2/sites-available/webapp.conf
  notify:
    - restart apache
